# TABLES Main Site

This is the public-facing Gatsby site generated from TABLES CMS content.

## Features

### ðŸš€ Static Site Generation (SSG) with Runtime Optimization

The site uses a **dual-mode approach** for optimal performance:

**Production Build (`gatsby build`)**:
- All data is **prerendered at build time** and embedded in page-data.json
- Data passed through `pageContext` to templates
- **Zero network requests** for content data (no `/data/*.json` fetches)
- Instant page loads with pre-baked content
- SEO-friendly with full static HTML
- Perfect Lighthouse scores

**Development Mode (`gatsby develop`)**:
- Data is **NOT** passed through `pageContext`
- Templates fetch data at runtime from `/data/*.json` files
- Enables hot reload without manual server restart
- Live updates when CMS data changes
- File watcher triggers automatic route rebuilds

### ðŸ”¥ Hot Reload in Development

The dev server automatically detects changes to static data files and triggers a route rebuild:

1. Edit content in the CMS at `/cms`
2. Changes are saved to `static/data/*.json`
3. File watcher detects the change
4. Gatsby's `/__refresh` endpoint is triggered automatically
5. Routes rebuild in ~2 seconds
6. Your changes appear without manual restart!

**Requirements**:
- `chokidar` package (already installed)
- `ENABLE_GATSBY_REFRESH_ENDPOINT=true` in `.env.development` (already configured)

## Project Structure

```
main-site/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ templates/           # Page templates
â”‚   â”‚   â”œâ”€â”€ page.js          # Generic page template
â”‚   â”‚   â”œâ”€â”€ blog-index.js    # Blog listing page
â”‚   â”‚   â”œâ”€â”€ blog-article.js  # Individual blog articles
â”‚   â”‚   â””â”€â”€ empty-home.js    # Fallback homepage
â”‚   â””â”€â”€ ...
â”œâ”€â”€ static/
â”‚   â””â”€â”€ data/                # CMS data (generated by parent CMS)
â”‚       â”œâ”€â”€ pages.json       # All pages
â”‚       â”œâ”€â”€ blog.json        # All blog articles
â”‚       â”œâ”€â”€ cats.json        # All categories
â”‚       â””â”€â”€ settings.json    # Site settings
â”œâ”€â”€ gatsby-node.js           # Page creation & hot reload logic
â”œâ”€â”€ gatsby-config.js         # Gatsby configuration
â””â”€â”€ .env.development         # Development environment variables
```

## Development

### Start the dev server

```bash
npm run develop
```

The site will be available at `http://localhost:3000`

### How Hot Reload Works

1. **File Watcher**: `gatsby-node.js` watches `static/data/*.json` files using chokidar
2. **Change Detection**: When a file changes, it triggers a POST request to `/__refresh`
3. **Route Rebuild**: Gatsby re-runs `createPages` to regenerate page routes
4. **Live Update**: New/updated pages are immediately accessible

**Console Output Example**:
```
[Gatsby Node] ðŸ”¥ Setting up hot reload for static/data/*.json
[Gatsby Node] Routes will rebuild automatically when data changes!

[Gatsby Node] ðŸ”„ Detected change in blog.json
[Gatsby Node] ðŸš€ Triggering automatic route rebuild...
[Gatsby Node] âœ… Routes rebuilt successfully!
[Gatsby Node] ðŸŽ‰ Your changes are now live!
```

### Manual Restart (if needed)

If hot reload fails, manually restart the dev server:

```bash
npm run develop
```

## Production Build

### Build the site

```bash
npm run build
```

This creates an optimized production build in the `public/` directory.

**Optimization Details**:
- All JSON data is embedded in page-data.json files
- No runtime network requests for content
- Full static HTML generation for SEO
- Optimized assets and code splitting

### Serve the production build locally

```bash
npm run serve
```

### Deploy to production server

```bash
npm run prod
```

This builds the site and starts an Express server on port 3000.

## Data Flow

### Development Mode (`gatsby develop`)

```
1. CMS Edit â†’ static/data/*.json saved
                    â†“
2. File Watcher detects change â†’ POST to /__refresh
                    â†“
3. Gatsby reruns createPages (WITHOUT passing data in pageContext)
                    â†“
4. Browser loads page â†’ Templates check pageContext (empty) â†’ Fetch /data/*.json
                    â†“
5. Live update in ~2 seconds! ðŸŽ‰
```

**Key Point**: In development, `gatsby-node.js` does NOT pass data through `pageContext`, forcing templates to fetch JSON at runtime.

### Production Build (`gatsby build`)

```
1. static/data/*.json read by gatsby-node.js
                    â†“
2. createPages WITH full data in pageContext
                    â†“
3. Data embedded in page-data.json files
                    â†“
4. Browser loads page â†’ Templates check pageContext (has data) â†’ Use it directly
                    â†“
5. Zero network requests! âš¡
```

**Key Point**: In production, `gatsby-node.js` passes full data through `pageContext`, eliminating runtime fetches.

## Template Data Loading

All templates follow this **dual-mode pattern**:

```javascript
const MyTemplate = ({ pageContext }) => {
  // Initialize with pageContext data if available (production)
  // or null if not (development)
  const [data, setData] = useState(pageContext.data || null);
  const [loading, setLoading] = useState(!pageContext.data);

  useEffect(() => {
    // Production: pageContext.data exists â†’ use it directly
    if (pageContext.data) {
      setData(pageContext.data);
      setLoading(false);
      return; // Skip fetch
    }

    // Development: pageContext.data is undefined â†’ fetch at runtime
    fetch('/data/something.json')
      .then(res => res.json())
      .then(data => {
        setData(data);
        setLoading(false);
      });
  }, [pageContext.data]);

  // ... render logic
};
```

**How it works**:
- **Development**: `pageContext.data` is `undefined` â†’ Template fetches JSON â†’ Hot reload works
- **Production**: `pageContext.data` exists â†’ Template uses it â†’ No fetch needed

## Environment Variables

### `.env.development` (already configured)

```env
ENABLE_GATSBY_REFRESH_ENDPOINT=true
```

This enables the `/__refresh` webhook for hot reload support.

## Troubleshooting

### Hot reload not working?

1. **Check chokidar is installed**:
   ```bash
   npm list chokidar
   ```
   If not: `npm install --save-dev chokidar`

2. **Verify .env.development exists** and contains:
   ```env
   ENABLE_GATSBY_REFRESH_ENDPOINT=true
   ```

3. **Check console for file watcher messages**:
   ```
   [Gatsby Node] ðŸ”¥ Setting up hot reload for static/data/*.json
   ```

4. **Manual restart** as fallback:
   ```bash
   npm run develop
   ```

### Pages showing old data?

- **Development**: 
  - Hot reload should update automatically in ~2 seconds
  - Check browser console for fetch requests to `/data/*.json`
  - If not updating, restart dev server
- **Production**: 
  - Must run `npm run build` to rebuild with latest data
  - No runtime updates possible (data is pre-baked)

### 404 errors for new pages?

- **Development**: 
  - Wait for automatic hot reload (~2 seconds after saving)
  - Check console for "Routes rebuilt successfully!" message
  - If still 404, restart dev server
- **Production**: 
  - New pages require full rebuild: `npm run build`
  - Deploy updated build to production

## Performance

### Development Mode
- Initial page load: ~100-200ms
  - Includes runtime fetch to `/data/*.json`
  - Network tab shows JSON requests
- Hot reload time: ~2 seconds (automatic)
- Subsequent page loads: Faster (browser caches JSON)

### Production Build
- Initial page load: ~20-50ms
  - **Zero network requests** for content
  - All data embedded in page-data.json
- Time to Interactive: <1 second
- Lighthouse Score: 95-100
- Perfect for SEO and performance

## Routes

- `/` - Homepage (or empty-home fallback)
- `/blog` - Blog index (all articles)
- `/blog/:year/:month/:slug` - Individual blog articles
- `/:slug` - Generic pages

## Technologies

- **Gatsby 5.12** - Static site generator
- **React 18** - UI framework
- **Chokidar** - File watching
- **Express** - Production server

## License

MIT