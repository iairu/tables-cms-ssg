name: Custom macOS Release

on:
  push:
    branches:
      - main  # Trigger on push to main

jobs:
  build-macos:
    runs-on: macos-latest
    permissions:
      contents: write # Needed to upload releases
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.18.0'

      - name: 1. Setup Support Binaries
        run: |
          # Ensure setup script is executable if needed
          node TABLES.app/Contents/MacOS/support-setup/bundle-node-npm.js
          
          # Verify the folder was created and populated
          ls -R TABLES.app/Contents/MacOS/support-bin

      - name: 2. Set Executable Permissions
        run: |
          # Crucial: Ensure macOS recognizes the shell wrappers as executables
          chmod +x "TABLES.app/Contents/MacOS/TABLES"
          chmod +x "TABLES.app/Contents/MacOS/start.sh"

      - name: 3. Create DMG
        run: |
          # Install create-dmg utility
          brew install create-dmg
          
          # Create the DMG container
          # Adjust --window-size and --icon-size as you like
          create-dmg \
            --volname "TABLES Installer" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --icon-size 100 \
            --icon "TABLES.app" 175 190 \
            --hide-extension "TABLES.app" \
            --app-drop-link 425 190 \
            "TABLES-v${{ github.run_number }}-mac.dmg" \
            "TABLES.app"

      - name: 4. Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.run_number }}
          name: Release v${{ github.run_number }}
          draft: false
          prerelease: false
          files: TABLES-v${{ github.run_number }}-mac.dmg
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}